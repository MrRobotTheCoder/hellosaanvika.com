# =========================================================
# Alertmanager (INLINE CONFIG â€” SINGLE SOURCE OF TRUTH)
# =========================================================
alertmanager:
  enabled: true

  nodeSelector:
    kubernetes.io/hostname: pi-control-plane

  extraVolumeMounts:
    - name: alertmanager-slack-secret
      mountPath: /etc/alertmanager/secrets
      readOnly: true

  extraVolumes:
    - name: alertmanager-slack-secret
      secret:
        secretName: alertmanager-slack-webhook

  config:
    global:
      resolve_timeout: 5m

    route:
      receiver: slack-notifications
      group_by: ["alertname", "service"]
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 4h

      routes:
        - matchers:
            - severity="critical"
          receiver: slack-notifications
          repeat_interval: 1h

    receivers:
      - name: slack-notifications
        slack_configs:
          - api_url_file: /etc/alertmanager/secrets/SLACK_WEBHOOK_URL
            channel: "#alerts-hellosaanvika"
            send_resolved: true
            title: "{{ .CommonAnnotations.summary }}"
            text: |
              {{ range .Alerts }}
              *Alert:* {{ .Annotations.summary }}
              *Description:* {{ .Annotations.description }}
              {{ end }}

# =========================================================
# Disable unused components
# =========================================================
prometheus-pushgateway:
  enabled: false

prometheus-node-exporter:
  enabled: false

# =========================================================
# Prometheus Server
# =========================================================
server:
  nodeSelector:
    kubernetes.io/hostname: pi-control-plane

  alertmanagers:
    - scheme: http
      path_prefix: /
      static_configs:
        - targets:
            - prometheus-alertmanager.monitoring.svc:9093

  persistentVolume:
    enabled: true
    size: 10Gi

# =========================================================
# Prometheus alert rules mount
# =========================================================
  extraConfigmapMounts:
    - name: prometheus-rules
      configMap: prometheus-rules
      mountPath: /etc/config/rules
      readOnly: true

# =========================================================
# Prometheus Scrape Configs
# =========================================================
  extraScrapeConfigs: |
    - job_name: "ingress-nginx"
      metrics_path: /metrics
      static_configs:
        - targets:
            - ingress-nginx-controller-metrics.ingress-nginx.svc.cluster.local:10254

# =========================================================
# Prometheus configuration
# =========================================================
serverFiles:
  prometheus.yml:
    rule_files:
      - /etc/config/rules/*.yaml


    scrape_configs:
      - job_name: "ingress-nginx"
        metrics_path: /metrics
        static_configs:
          - targets:
              - ingress-nginx-controller-metrics.ingress-nginx.svc.cluster.local:10254
